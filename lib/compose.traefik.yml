services:
  traefik-proxy:
    image: traefik:2.10
    restart: always
    depends_on:
      - socket-proxy
    command:
      - --entrypoints.https.http.tls.domains[rootDomain].main=$ROOT_DOMAIN_NAME
      - --entrypoints.https.http.tls.domains[rootDomain].sans=*.$ROOT_DOMAIN_NAME
      - --tls.stores.default.defaultCertificate.certFile=/certs/local.crt
      - --tls.stores.default.defaultCertificate.keyFile=/certs/local.key
    networks:
      - traefik-internal
      - traefik-proxy
      - socket-proxy
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: [ 'CMD', 'traefik', 'healthcheck', '--ping' ]
      interval: 5s
      retries: 3
    ports:
      - '0.0.0.0:80:80'
      - '0.0.0.0:443:443'
    volumes:
      - './traefik/traefik.yml:/etc/traefik/traefik.yml:ro'   # Static Traefik Configuration
      - './traefik/dynamic/:/etc/traefik/dynamic/:ro'         # Folder to store dynamic configuration file provider
      - './traefik/acme/cloudflare.json:/etc/traefik/acme/cloudflare.json'    # certificate storage
      - './traefik/traefik.log:/etc/traefik/traefik.log'    # traefik log
      - './traefik/access.log:/etc/traefik/access.log'      # access log
      - '../certs/:/etc/traefik/certs/:ro'                  # certificate storage
    environment:
      ROOT_DOMAIN_NAME: '${ROOT_DOMAIN_NAME}'
      TRAEFIK_DOMAIN_NAME: '${TRAEFIK_DOMAIN_NAME}'
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.http-catchall.entrypoints=http'
      - 'traefik.http.routers.http-catchall.rule=HostRegexp(`{host:.+}`)'
      - 'traefik.http.routers.http-catchall.middlewares=middlewares-https-redirect-scheme@file'
      - 'traefik.http.routers.traefik-rtr.tls=true'
      - 'traefik.http.routers.traefik-rtr.entrypoints=https'
      - 'traefik.http.routers.traefik-rtr.rule=Host(`${TRAEFIK_DOMAIN_NAME}`)'
      - 'traefik.http.routers.traefik-rtr.service=api@internal'
      - 'traefik.http.routers.ping.rule=Host(`${TRAEFIK_DOMAIN_NAME}`) && Path(`/ping`)'
      - 'traefik.http.routers.ping.tls=true'
      - 'traefik.http.routers.ping.service=ping@internal'
